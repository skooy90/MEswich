<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MES ÎåÄÏãúÎ≥¥Îìú</title>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Ìó§Îçî Ìè¨Ìï® -->
    <jsp:include page="../basic/header.jsp" />
    
    <!-- ÏÇ¨Ïù¥ÎìúÎ∞î Ìè¨Ìï® -->
    <jsp:include page="../basic/sidebar.jsp" />
    
    <!-- ÎåÄÏãúÎ≥¥Îìú Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>MES ÎåÄÏãúÎ≥¥Îìú</h1>
            <p>ÏÉùÏÇ∞ ÌòÑÌô© Î™®ÎãàÌÑ∞ÎßÅ</p>
        </div>
        
        <!-- 6Í∞ú ÏúÑÏ†Ø Í∑∏Î¶¨Îìú -->
        <div class="widget-grid">
            
            <!-- 1Î≤à ÏúÑÏ†Ø: Ï†ÑÏ≤¥ ÏÉùÏÇ∞Îüâ (Ìï≠Î™© ÏÑ†ÌÉù Í∏∞Îä• Ï∂îÍ∞Ä) -->
            <div class="widget-card production-widget">
                <div class="widget-header">
                    <h3>Ï†ÑÏ≤¥ ÏÉùÏÇ∞Îüâ</h3>
                    <div class="widget-icon">üìä</div>
                </div>
                <div class="widget-content">
                    
                    <!-- ÏÉùÏÇ∞ Ìï≠Î™© ÏÑ†ÌÉù -->
                    <div class="production-selector">
                        <label for="productionSelect">ÏÉùÏÇ∞ Ìï≠Î™© ÏÑ†ÌÉù:</label>
                        <select id="productionSelect" onchange="loadProductionDetail()">
                            <option value="">Ï†ÑÏ≤¥ ÏÉùÏÇ∞Îüâ Î≥¥Í∏∞</option>
                            <c:forEach var="production" items="${allProductions}">
                                <option value="${production.lotNumber}" 
                                        ${selectedLot == production.lotNumber ? 'selected' : ''}>
                                    ${production.lotNumber} - ${production.productName}
                                </option>
                            </c:forEach>
                        </select>
                        </div>
                        
                    <!-- ÏÑ†ÌÉùÎêú Ìï≠Î™© ÏÉÅÏÑ∏ Ï†ïÎ≥¥ (Ìï≠ÏÉÅ ÌëúÏãú) -->
                    <div class="selected-production-info" id="selected-production-card">
                        <h4>ÏÑ†ÌÉùÎêú ÏÉùÏÇ∞ Ìï≠Î™© Ï†ïÎ≥¥</h4>
                        <div class="production-details">
                            <div class="detail-row">
                                <span class="detail-label">LOT Î≤àÌò∏:</span>
                                <span class="detail-value" id="selected-lot-number">
                                    <c:choose>
                                        <c:when test="${not empty selectedProduction}">${selectedProduction.lotNumber}</c:when>
                                        <c:otherwise>Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</c:otherwise>
                                    </c:choose>
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Ï†úÌíàÎ™Ö:</span>
                                <span class="detail-value" id="selected-product-name">
                                    <c:choose>
                                        <c:when test="${not empty selectedProduction}">${selectedProduction.productName}</c:when>
                                        <c:otherwise>-</c:otherwise>
                                    </c:choose>
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Í≥ÑÌöç ÏàòÎüâ:</span>
                                <span class="detail-value" id="selected-planned-qty">
                                    <c:choose>
                                        <c:when test="${not empty selectedProduction}">
                                            <fmt:formatNumber value="${selectedProduction.plannedQty}" pattern="#,###" />Í∞ú
                                        </c:when>
                                        <c:otherwise>-</c:otherwise>
                                    </c:choose>
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Ïã§Ï†ú ÏàòÎüâ:</span>
                                <span class="detail-value" id="selected-actual-qty">
                                    <c:choose>
                                        <c:when test="${not empty selectedProduction}">
                                            <fmt:formatNumber value="${selectedProduction.actualQty}" pattern="#,###" />Í∞ú
                                        </c:when>
                                        <c:otherwise>-</c:otherwise>
                                    </c:choose>
                                </span>
                                </div>
                            <div class="detail-row">
                                <span class="detail-label">ÏÉÅÌÉú:</span>
                                <span class="detail-value" id="selected-status">
                                    <c:choose>
                                        <c:when test="${not empty selectedProduction}">
                                            <span class="status-${selectedProduction.status.toLowerCase()}">${selectedProduction.status}</span>
                                        </c:when>
                                        <c:otherwise>-</c:otherwise>
                                    </c:choose>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ï†ÑÏ≤¥ ÏÉùÏÇ∞Îüâ ÌÜµÍ≥Ñ (Ìï≠Î™©Ïù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏùÑ ÎïåÎßå ÌëúÏãú) -->
                    <!-- ÏÉùÏÇ∞Îüâ ÎπÑÍµê Ï∞®Ìä∏ -->
                    <div class="chart-container">
                        <canvas id="productionChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 2Î≤à ÏúÑÏ†Ø: ÎÇ†ÏßúÎ≥Ñ Î∂àÎüâ Í∞ØÏàò ÌòÑÌô© -->
            <div class="widget-card defect-stats-widget">
                <div class="widget-header">
                    <h3>ÎÇ†ÏßúÎ≥Ñ Î∂àÎüâ Í∞ØÏàò ÌòÑÌô©</h3>
                    <div class="widget-icon">üìä</div>
                </div>
                <div class="widget-content">
                    <!-- Ï¥ù Î∂àÎüâ Í∞ØÏàò ÌëúÏãú -->
                    <div class="defect-summary">
                        <div class="defect-total">
                            <span class="defect-number" id="total-defects">${defectStats.totalDefects}</span>
                            <span class="defect-unit">Í∞ú</span>
                        </div>
                        <div class="defect-label">Ï¥ù Î∂àÎüâ Í∞ØÏàò</div>
                    </div>
                    
                    <!-- ÎÇ†ÏßúÎ≥Ñ Î∂àÎüâ Í∞ØÏàò Ï∞®Ìä∏ -->
                    <div class="defect-chart-container">
                        <canvas id="defectChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 3Î≤à ÏúÑÏ†Ø: Î∂àÎüâ ÏõêÏù∏Î≥Ñ ÌöüÏàò -->
            <div class="widget-card defect-cause-widget">
                <div class="widget-header">
                    <h3>Î∂àÎüâ ÏõêÏù∏Î≥Ñ ÌöüÏàò</h3>
                    <div class="widget-icon">üîç</div>
                </div>
                <div class="widget-content">
                    <!-- Ï¥ù Î∂àÎüâ Í∞ØÏàò ÌëúÏãú -->
                    <div class="defect-cause-summary">
                        <div class="defect-cause-total">
                            <span class="defect-cause-number" id="total-defect-causes">${defectCauseStats.totalDefects}</span>
                            <span class="defect-cause-unit">Ìöå</span>
                        </div>
                        <div class="defect-cause-label">Ï¥ù Î∂àÎüâ ÌöüÏàò</div>
                    </div>
                    
                    <!-- Î∂àÎüâ ÏõêÏù∏Î≥Ñ ÎèÑÎÑõ Ï∞®Ìä∏ -->
                    <div class="defect-cause-chart-container">
                        <canvas id="defectCauseChart"></canvas>
                    </div>
                    
                    <!-- Î∂àÎüâ ÏõêÏù∏Î≥Ñ Î≤îÎ°Ä -->
                    <div class="defect-cause-legend" id="defect-cause-legend">
                        <c:if test="${not empty defectCauseStats.causeList}">
                            <c:forEach var="cause" items="${defectCauseStats.causeList}" varStatus="status">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: <c:choose><c:when test="${status.index == 0}">#e74c3c</c:when><c:when test="${status.index == 1}">#f39c12</c:when><c:otherwise>#3498db</c:otherwise></c:choose>"></div>
                                    <div class="legend-text">
                                        <span class="legend-name">${cause.causeName}</span>
                                        <span class="legend-count">${cause.defectCount}Ìöå (${cause.percentage}%)</span>
                                    </div>
                                </div>
                            </c:forEach>
                        </c:if>
                    </div>
                </div>
            </div>
            
            <!-- 4Î≤à ÏúÑÏ†Ø: ÏûëÏóÖÌòÑÌô© -->
            <div class="widget-card work-status-widget">
                <div class="widget-header">
                    <h3>ÏûëÏóÖÌòÑÌô©</h3>
                    <div class="widget-icon">üìä</div>
                </div>
                <div class="widget-content">
                    <!-- Ï¥ù ÏûëÏóÖ ÌòÑÌô© Ïπ¥Îìú -->
                    <div class="work-summary">
                        <div class="work-total">
                            <span class="work-number">${workStatusStats.totalWorks}</span>
                            <span class="work-unit">Í∞ú</span>
                        </div>
                        <div class="work-label">Ï¥ù ÏûëÏóÖ Ïàò</div>
                    </div>
                    
                    <!-- ÏûëÏóÖ ÏÉÅÌÉúÎ≥Ñ ÎèÑÎÑõ Ï∞®Ìä∏ -->
                    <div class="work-chart-container">
                        <canvas id="workStatusChart"></canvas>
                    </div>
                    
                    <!-- ÏôÑÏ†úÌíàÎ≥Ñ ÌòÑÌô© ÌÖåÏù¥Î∏î -->
                    <div class="product-status-table">
                        <c:if test="${not empty workStatusStats.productList}">
                            <c:forEach var="product" items="${workStatusStats.productList}">
                                <div class="product-row">
                                    <div class="product-info">
                                        <span class="product-name">${product.productName}</span>
                                        <span class="product-qty">Í≥ÑÌöç: ${product.plannedQty} | Ïã§Ï†ú: ${product.actualQty}</span>
                                    </div>
                                    <div class="product-rate">${product.completionRate}%</div>
                                </div>
                            </c:forEach>
                        </c:if>
                    </div>
                </div>
            </div>
            
            <!-- 5Î≤à ÏúÑÏ†Ø: ÏñëÌíàÌòÑÌô© (ÎØ∏Íµ¨ÌòÑ) -->
            <div class="widget-card quality-widget">
                <div class="widget-header">
                    <h3>ÏñëÌíàÌòÑÌô©</h3>
                    <div class="widget-icon">‚úÖ</div>
                </div>
                <div class="widget-content">
                    <div class="coming-soon">
                        <div class="coming-soon-icon">üöß</div>
                        <p>Íµ¨ÌòÑ ÏòàÏ†ï</p>
                        <small>ÌíàÏßà ÌòÑÌô© Î∞è ÏñëÌíàÎ•†</small>
                    </div>
                </div>
            </div>
            
            <!-- 6Î≤à ÏúÑÏ†Ø: LOT Ï∂îÏ†Å (ÎØ∏Íµ¨ÌòÑ) -->
            <div class="widget-card lot-tracking-widget">
                <div class="widget-header">
                    <h3>LOT Ï∂îÏ†Å</h3>
                    <div class="widget-icon">üîç</div>
                </div>
                <div class="widget-content">
                    <div class="coming-soon">
                        <div class="coming-soon-icon">üöß</div>
                        <p>Íµ¨ÌòÑ ÏòàÏ†ï</p>
                        <small>LOT Î≤àÌò∏ Í≤ÄÏÉâ Í∏∞Îä•</small>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    
    <script>
        // ÏÉùÏÇ∞ Ìï≠Î™© ÏÑ†ÌÉù Ïãú ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú
        function loadProductionDetail() {
            const selectedLot = document.getElementById('productionSelect').value;
            if (selectedLot) {
                // ÏÑ†ÌÉùÎêú Ìï≠Î™©Ïùò ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º AJAXÎ°ú Î°úÎìú
                fetch('/mes/dashboard/api/production-detail?lotNumber=' + encodeURIComponent(selectedLot))
                    .then(response => response.json())
                    .then(data => {
                        console.log('Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞:', data); // ÎîîÎ≤ÑÍπÖÏö©
                        updateProductionDetail(data);
                        updateChart(data);
                    })
                    .catch(error => {
                        console.error('ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎìú Ï§ë Ïò§Î•ò:', error);
                        alert('Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                    });
            } else {
                // Ï†ÑÏ≤¥ ÏÉùÏÇ∞Îüâ Î≥¥Í∏∞Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞ - Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ Ïπ¥ÎìúÎì§ Îã§Ïãú Î≥¥Ïù¥Í∏∞
                const overallStatsCards = document.getElementById('overall-stats-cards');
                if (overallStatsCards) {
                    overallStatsCards.style.display = 'grid';
                }
                
                // ÏÑ†ÌÉùÎêú Ìï≠Î™© Ï†ïÎ≥¥ Ï¥àÍ∏∞Ìôî
                const lotNumberElement = document.getElementById('selected-lot-number');
                const productNameElement = document.getElementById('selected-product-name');
                const plannedQtyElement = document.getElementById('selected-planned-qty');
                const actualQtyElement = document.getElementById('selected-actual-qty');
                const statusElement = document.getElementById('selected-status');
                
                if (lotNumberElement) lotNumberElement.textContent = 'Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî';
                if (productNameElement) productNameElement.textContent = '-';
                if (plannedQtyElement) plannedQtyElement.textContent = '-';
                if (actualQtyElement) actualQtyElement.textContent = '-';
                if (statusElement) statusElement.innerHTML = '-';
                
                // Ï∞®Ìä∏ÎèÑ Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Î°ú ÏóÖÎç∞Ïù¥Ìä∏
                updateChart(null);
            }
        }
        
        // ÏÑ†ÌÉùÎêú ÏÉùÏÇ∞ Ìï≠Î™© ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ (Í∏∞Ï°¥ Ïπ¥ÎìúÏùò Í∞íÎßå Î≥ÄÍ≤Ω)
        function updateProductionDetail(data) {
            if (!data) {
                console.error('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // IDÎ°ú ÏöîÏÜåÎ•º Ï∞æÏïÑÏÑú Í∞íÎßå ÏóÖÎç∞Ïù¥Ìä∏ (ÏÉàÎ°úÏö¥ HTML ÏÉùÏÑ±ÌïòÏßÄ ÏïäÏùå)
            const lotNumberElement = document.getElementById('selected-lot-number');
            const productNameElement = document.getElementById('selected-product-name');
            const plannedQtyElement = document.getElementById('selected-planned-qty');
            const actualQtyElement = document.getElementById('selected-actual-qty');
            const statusElement = document.getElementById('selected-status');
            
            if (lotNumberElement) lotNumberElement.textContent = data.lotNumber || 'N/A';
            if (productNameElement) productNameElement.textContent = data.productName || 'N/A';
            if (plannedQtyElement) plannedQtyElement.textContent = (data.plannedQty || 0).toLocaleString() + 'Í∞ú';
            if (actualQtyElement) actualQtyElement.textContent = (data.actualQty || 0).toLocaleString() + 'Í∞ú';
            if (statusElement) {
                statusElement.innerHTML = '<span class="status-' + (data.status || '').toLowerCase() + '">' + (data.status || 'N/A') + '</span>';
            }
            
            // Ï†ÑÏ≤¥ ÏÉùÏÇ∞Îüâ ÌÜµÍ≥Ñ Ïπ¥ÎìúÎì§ Ïà®Í∏∞Í∏∞
            const overallStatsCards = document.getElementById('overall-stats-cards');
            if (overallStatsCards) {
                overallStatsCards.style.display = 'none';
            }
        }
        
        // Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateChart(data) {
            if (data && data.plannedQty !== undefined && data.actualQty !== undefined) {
                // ÏÑ†ÌÉùÎêú Ìï≠Î™©Ïùò Îç∞Ïù¥ÌÑ∞Î°ú Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                productionChart.data.datasets[0].data = [data.plannedQty, data.actualQty];
                productionChart.data.labels = ['Í≥ÑÌöç ÏàòÎüâ', 'Ïã§Ï†ú ÏàòÎüâ'];
                productionChart.options.plugins.title.text = data.lotNumber + ' - ' + data.productName;
            } else {
                // Ï†ÑÏ≤¥ ÏÉùÏÇ∞Îüâ Îç∞Ïù¥ÌÑ∞Î°ú Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                productionChart.data.datasets[0].data = [
                    ${productionStats.totalPlannedQty},
                    ${productionStats.totalActualQty}
                ];
                productionChart.data.labels = ['Ï¥ù Í≥ÑÌöç ÏàòÎüâ', 'Ï¥ù Ïã§Ï†ú ÏàòÎüâ'];
                productionChart.options.plugins.title.text = 'Ï†ÑÏ≤¥ ÏÉùÏÇ∞Îüâ ÎπÑÍµê';
            }
            productionChart.update();
        }
        
        // Ï¥àÍ∏∞ Ï∞®Ìä∏ ÏÉùÏÑ±
        const productionCtx = document.getElementById('productionChart').getContext('2d');
        const productionChart = new Chart(productionCtx, {
            type: 'bar',
            data: {
                labels: ['Í≥ÑÌöç ÏàòÎüâ', 'Ïã§Ï†ú ÏàòÎüâ'],
                datasets: [{
                    label: 'ÏÉùÏÇ∞Îüâ',
                    data: [
                        ${productionStats.totalPlannedQty},
                        ${productionStats.totalActualQty}
                    ],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(75, 192, 192, 0.8)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Ï†ÑÏ≤¥ ÏÉùÏÇ∞Îüâ ÎπÑÍµê'
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + 'Í∞ú';
                            }
                        }
                    }
                }
            }
        });
        
//         // 30Ï¥àÎßàÎã§ 1Î≤à ÏúÑÏ†Ø Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
//         setInterval(function() {
//             fetch('/mes/dashboard/api/production-stats')
//                 .then(response => response.json())
//                 .then(data => {
//                     // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
//                     productionChart.data.datasets[0].data = [
//                         data.totalPlannedQty,
//                         data.totalActualQty
//                     ];
//                     productionChart.update();
//                 })
//                 .catch(error => {
//                     console.error('Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® Ï§ë Ïò§Î•ò:', error);
//                 });
//         }, 30000);
        
        // 2Î≤à ÏúÑÏ†Ø: Î∂àÎüâ ÌÜµÍ≥Ñ Ï∞®Ìä∏ ÏÉùÏÑ±
        let defectChart = null;
        
        // Î∂àÎüâ ÌÜµÍ≥Ñ Ï∞®Ìä∏ ÏÉùÏÑ±
        function createDefectChart() {
            const ctx = document.getElementById('defectChart');
            if (!ctx) return;
            
            // ÏÑúÎ≤ÑÏÇ¨Ïù¥Îìú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
            const dailyDefects = [
                <c:forEach var="daily" items="${defectStats.dailyDefects}" varStatus="status">
                {dateStr: '${daily.dateStr}', defectCount: ${daily.defectCount}}<c:if test="${!status.last}">,</c:if>
                </c:forEach>
            ];
            
            if (!dailyDefects || dailyDefects.length === 0) return;
            
            // Í∏∞Ï°¥ Ï∞®Ìä∏Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
            if (defectChart) {
                defectChart.destroy();
            }
            
            const labels = dailyDefects.map(item => item.dateStr);
            const defectCounts = dailyDefects.map(item => item.defectCount);
            
            defectChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Î∂àÎüâ Í∞ØÏàò',
                        data: defectCounts,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ÎÇ†ÏßúÎ≥Ñ Î∂àÎüâ Í∞ØÏàò Ï∂îÏù¥'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'Í∞ú';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï∞®Ìä∏ ÏÉùÏÑ±
        document.addEventListener('DOMContentLoaded', function() {
            // ÏÑúÎ≤ÑÏÇ¨Ïù¥Îìú Îç∞Ïù¥ÌÑ∞Î°ú Ï∞®Ìä∏ ÏÉùÏÑ±
            createDefectChart();
            createDefectCauseChart();
            createWorkStatusChart();
        });
        
        // 3Î≤à ÏúÑÏ†Ø: Î∂àÎüâ ÏõêÏù∏Î≥Ñ ÎèÑÎÑõ Ï∞®Ìä∏ ÏÉùÏÑ±
        let defectCauseChart = null;
        
        // Î∂àÎüâ ÏõêÏù∏Î≥Ñ ÎèÑÎÑõ Ï∞®Ìä∏ ÏÉùÏÑ±
        function createDefectCauseChart() {
            const ctx = document.getElementById('defectCauseChart');
            if (!ctx) return;
            
            // ÏÑúÎ≤ÑÏÇ¨Ïù¥Îìú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
            const causeList = [
                <c:forEach var="cause" items="${defectCauseStats.causeList}" varStatus="status">
                {causeName: '${cause.causeName}', defectCount: ${cause.defectCount}, percentage: ${cause.percentage}}<c:if test="${!status.last}">,</c:if>
                </c:forEach>
            ];
            
            if (!causeList || causeList.length === 0) return;
            
            // Í∏∞Ï°¥ Ï∞®Ìä∏Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
            if (defectCauseChart) {
                defectCauseChart.destroy();
            }
            
            const labels = causeList.map(item => item.causeName);
            const defectCounts = causeList.map(item => item.defectCount);
            const percentages = causeList.map(item => item.percentage);
            
            // ÏÉâÏÉÅ Î∞∞Ïó¥ (3Í∞ÄÏßÄ ÏõêÏù∏Ïóê ÎßûÏ∂§)
            const colors = ['#e74c3c', '#f39c12', '#3498db'];
            const backgroundColors = colors.map(color => color + '80'); // Ìà¨Î™ÖÎèÑ Ï∂îÍ∞Ä
            
            defectCauseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Î∂àÎüâ Í∞ØÏàò',
                        data: defectCounts,
                        backgroundColor: backgroundColors,
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Î∂àÎüâ ÏõêÏù∏Î≥Ñ Î∂ÑÌè¨'
                        },
                        legend: {
                            display: false // Î≤îÎ°ÄÎäî Î≥ÑÎèÑÎ°ú ÌëúÏãú
                        }
                    },
                    cutout: '60%' // ÎèÑÎÑõ Ï∞®Ìä∏Ïùò ÎÇ¥Î∂Ä Íµ¨Î©ç ÌÅ¨Í∏∞
                }
            });
            
        }
        
        // 4Î≤à ÏúÑÏ†Ø: ÏûëÏóÖÌòÑÌô© ÎèÑÎÑõ Ï∞®Ìä∏ ÏÉùÏÑ±
        let workStatusChart = null;
        
        // ÏûëÏóÖÌòÑÌô© ÎèÑÎÑõ Ï∞®Ìä∏ ÏÉùÏÑ±
        function createWorkStatusChart() {
            const ctx = document.getElementById('workStatusChart');
            if (!ctx) return;
            
            // ÏÑúÎ≤ÑÏÇ¨Ïù¥Îìú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
            const statusList = [
            	<c:forEach var="workStatus" items="${workStatusStats.statusList}" varStatus="status">
                {status: '${workStatus.status}', workCount: ${workStatus.workCount}}<c:if test="${!status.last}">,</c:if>
            </c:forEach>
            ];
            
            if (!statusList || statusList.length === 0) return;
            
            // Í∏∞Ï°¥ Ï∞®Ìä∏Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
            if (workStatusChart) {
                workStatusChart.destroy();
            }
            
            const labels = statusList.map(item => item.status);
            const workCounts = statusList.map(item => item.workCount);
            
            // ÏÉâÏÉÅ Î∞∞Ïó¥ (ÏûëÏóÖ ÏÉÅÌÉúÎ≥Ñ)
            const colors = ['#3498db', '#f39c12', '#2ecc71', '#e74c3c'];
            const backgroundColors = colors.map(color => color + '80'); // Ìà¨Î™ÖÎèÑ Ï∂îÍ∞Ä
            
            workStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ÏûëÏóÖ Ïàò',
                        data: workCounts,
                        backgroundColor: backgroundColors,
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ÏûëÏóÖ ÏÉÅÌÉúÎ≥Ñ Î∂ÑÌè¨'
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    cutout: '60%' // ÎèÑÎÑõ Ï∞®Ìä∏Ïùò ÎÇ¥Î∂Ä Íµ¨Î©ç ÌÅ¨Í∏∞
                }
            });
        }
    </script>
</body>
</html>